<?xml version="1.0" encoding="UTF-8" ?>
<process
    name="travelGoodBPELModule"
    targetNamespace="http://enterprise.netbeans.org/bpel/TravelGoodBPELModule/travelGoodBPELModule"
    xmlns:tns="http://enterprise.netbeans.org/bpel/TravelGoodBPELModule/travelGoodBPELModule"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
    xmlns:sxt="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Trace" 
    xmlns:sxed="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Editor2"
    xmlns:sxat="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/Attachment"
    xmlns:sxeh="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/ErrorHandling" xmlns:ns0="urn://travelGoodTypes" xmlns:ns1="urn:flightData" xmlns:ns2="urn://travelGood" xmlns:ns3="urn://hotelReservationTypes" xmlns:sxxf="http://www.sun.com/wsbpel/2.0/process/executable/SUNExtension/XPathFunctions" xmlns:ns4="http://dk.dtu.02267.hotelservice/WSDL" xmlns:ns5="http://lameDuck.ws">
    <import namespace="urn://travelGood" location="travelGood.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://dk.dtu.02267.hotelservice/WSDL" location="http://localhost:8080/HotelReservation/hotelService?wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="http://lameDuck.ws" location="http://localhost:8080/LameDuck/lameDuckService?wsdl" importType="http://schemas.xmlsoap.org/wsdl/"/>
    <import namespace="urn://travelGoodTypes" location="travelGood.xsd" importType="http://www.w3.org/2001/XMLSchema"/>
    <partnerLinks>
        <partnerLink name="travelGoodLink" partnerLinkType="ns2:travelGood" myRole="travelGoodPortRole"/>
        <partnerLink name="HotelLink" xmlns:tns="http://dk.dtu.02267.hotelservice/WSDL" partnerLinkType="tns:partnerlinktype1" partnerRole="hotelServiceRole"/>
        <partnerLink name="flightLink" xmlns:tns="http://lameDuck.ws" partnerLinkType="tns:partnerlinktype1" partnerRole="lameDuckServiceRole"/>
    </partnerLinks>
    <variables>
        <variable name="cancellingPhase" type="xsd:boolean"/>
        <variable name="CancelBookingOperationOut" messageType="ns2:cancelBookingResponse"/>
        <variable name="CancelBookingOperationIn" messageType="ns2:cancelBookingRequest"/>
        <variable name="ReadItineraryOperationOut" messageType="ns2:readItineraryOperationResponse"/>
        <variable name="ReadItineraryOperationIn" messageType="ns2:readItineraryOperationRequest"/>
        <variable name="BookItineraryOperationOut" messageType="ns2:bookItineraryResponse"/>
        <variable name="BookItineraryOperationIn" messageType="ns2:bookItineraryRequest"/>
        <variable name="hotelToBook" type="ns0:x_hotelBooking"/>
        <variable name="sizeOfHotelList" type="xsd:int"/>
        <variable name="AddHotelToItineraryOperationOut" messageType="ns2:addHotelToItineraryResponse"/>
        <variable name="AddHotelToItineraryOperationIn" messageType="ns2:addHotelToItineraryRequest"/>
        <variable name="GetItineraryOperationIn" messageType="ns2:getItineraryRequest"/>
        <variable name="flightToBook" type="ns0:x_flightBooking"/>
        <variable name="GetItineraryOperationOut" messageType="ns2:getItineraryResponse"/>
        <variable name="sizeOfFlightList" type="xsd:int"/>
        <variable name="AddFlightToItineraryOperationOut" messageType="ns2:addFlightToItineraryResponse"/>
        <variable name="AddFlightToItineraryOperationIn" messageType="ns2:addFlightToItineraryRequest"/>
        <variable name="BPEL_itinerary" element="ns0:x_itinerary">
            <sxed:editor>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList/ns0:flightBooking[$sizeOfFlightList + 1]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$sizeOfHotelList + 1]" source="to"/>
               
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCounter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachBookedFlightCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachBookedFlightCounter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="to"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]" source="from"/>
                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]" source="to"/>
            </sxed:editor>
        </variable>
        <variable name="CancelItineraryOperationOut" messageType="ns2:cancelItineraryResponse"/>
        <variable name="CancelItineraryOperationIn" messageType="ns2:cancelItineraryRequest"/>
        <variable name="planning" type="xs:boolean"/>
        <variable name="CreateItineraryOperationOut" messageType="ns2:createItineraryResponse"/>
        <variable name="CreateItineraryOperationIn" messageType="ns2:createItineraryRequest"/>
        <variable name="ListHotelsOperationOut" messageType="ns2:listHotelsResponse"/>
        <variable name="GetHotelsOperationOut" xmlns:tns="http://dk.dtu.02267.hotelservice/WSDL" messageType="tns:getHotelsOperationResponse"/>
        <variable name="GetHotelsOperationIn" xmlns:tns="http://dk.dtu.02267.hotelservice/WSDL" messageType="tns:getHotelsOperationRequest"/>
        <variable name="ListHotelsOperationIn" xmlns:tns="urn://travelGood" messageType="tns:listHotelsRequest"/>
        <variable name="ListFlightsOperationOut" xmlns:tns="urn://travelGood" messageType="tns:listFlightsResponse"/>
        <variable name="ListFlightsOperationIn" xmlns:tns="urn://travelGood" messageType="tns:listFlightsRequest"/>
        <variable name="GetFlightsOut" xmlns:tns="http://lameDuck.ws" messageType="tns:getFlightsResponse"/>
        <variable name="GetFlightsIn" xmlns:tns="http://lameDuck.ws" messageType="tns:getFlightsRequest"/>
    </variables>
    <correlationSets>
        <correlationSet name="CorrelationSet1" properties="ns2:itineraryNo ns2:customerID"/>
    </correlationSets>
    <sequence>
        <sequence name="Sequence7">
            <receive name="ReceiveCreateRequest" createInstance="yes" partnerLink="travelGoodLink" operation="createItineraryOperation" portType="ns2:travelGoodPortType" variable="CreateItineraryOperationIn">
                <correlations>
                        <correlation set="CorrelationSet1" initiate="yes"/>
                    </correlations>
            </receive>
            <assign name="AssignVar">
                <copy>
                        <from>'unconfirmed'</from>
                            <to>$BPEL_itinerary/ns0:itineraryStatus</to>
                    </copy>
                    <copy>
                        <from>$CreateItineraryOperationIn.creatQuery/itineraryNo</from>
                            <to>$BPEL_itinerary/ns0:itineraryNo</to>
                    </copy>
                    <copy>
                        <from>$CreateItineraryOperationIn.creatQuery/customerID</from>
                            <to>$CreateItineraryOperationOut.createItineraryResult/customerID</to>
                    </copy>
                    <copy>
                        <from>$CreateItineraryOperationIn.creatQuery/itineraryNo</from>
                            <to>$CreateItineraryOperationOut.createItineraryResult/itineraryNo</to>
                    </copy>
                    <copy>
                        <from>'success'</from>
                            <to>$CreateItineraryOperationOut.createItineraryResult/status</to>
                    </copy>
            </assign>
            <reply name="ReplyCreateIT" partnerLink="travelGoodLink" operation="createItineraryOperation" portType="ns2:travelGoodPortType" variable="CreateItineraryOperationOut"/>
            <assign name="InitialVar">
                <copy>
                        <from>true()</from>
                            <to variable="planning"/>
                    </copy>
            </assign>
        </sequence>
        <while name="planning">
            <condition>$planning</condition>
            <pick name="Pick1" xmlns:tns="http://lameDuck.ws">
                <onMessage partnerLink="travelGoodLink" operation="listHotelsOperation" portType="ns2:travelGoodPortType" variable="ListHotelsOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence1">
                        <assign name="AssignInputListH">
                            <copy>
                                    <from>$ListHotelsOperationIn.hotelQueryRequest/ns3:hotelQuery</from>
                                        <to variable="GetHotelsOperationIn" part="hotelQuery"/>
                                </copy>
                        </assign>
                        <invoke name="InvokeGetHotel" partnerLink="HotelLink" operation="getHotelsOperation" xmlns:tns="http://dk.dtu.02267.hotelservice/WSDL" portType="tns:hotelServicePortType" inputVariable="GetHotelsOperationIn" outputVariable="GetHotelsOperationOut"/>
                        <assign name="AssignReplyVarH">
                            <copy>
                                    <from variable="GetHotelsOperationOut" part="hotelArray"/>
                                        <to variable="ListHotelsOperationOut" part="hotelArray"/>
                                </copy>
                        </assign>
                        <reply name="ReplyListHotel" partnerLink="travelGoodLink" operation="listHotelsOperation" portType="ns2:travelGoodPortType" variable="ListHotelsOperationOut"/>
                            </sequence>
                    </onMessage>
                    <onMessage partnerLink="travelGoodLink" operation="listFlightsOperation" portType="ns2:travelGoodPortType" variable="ListFlightsOperationIn">
                        <correlations>
                            <correlation set="CorrelationSet1" initiate="no"/>
                        </correlations>
                        <sequence name="Sequence2">
                                <assign name="AssignInputListF">
                                        <copy>
                                                <from>$ListFlightsOperationIn.flightQuery/ns1:getFlightQuery</from>
                                                    <to variable="GetFlightsIn" part="getFlightQuery"/>
                                            </copy>
                                    </assign>
                                    <invoke name="InvokeGetFlight" partnerLink="flightLink" operation="getFlights" xmlns:tns="http://lameDuck.ws" portType="tns:lameDuckPortType" inputVariable="GetFlightsIn" outputVariable="GetFlightsOut"/>
                                    <assign name="AssignReplyVarF">
                                        <copy>
                                                <from variable="GetFlightsOut" part="flightsList"/>
                                                    <to variable="ListFlightsOperationOut" part="flightList"/>
                                            </copy>
                                    </assign>
                                    <reply name="ReplyListFlight" partnerLink="travelGoodLink" operation="listFlightsOperation" portType="ns2:travelGoodPortType" variable="ListFlightsOperationOut"/>
                            </sequence>
                    </onMessage>
       
                <onMessage partnerLink="travelGoodLink" operation="addFlightToItineraryOperation" portType="ns2:travelGoodPortType" variable="AddFlightToItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence4">
                        <assign name="initialVarFlight">
                            <copy>
                                <from>count($BPEL_itinerary/ns0:flightBookingList/ns0:flightInfo)</from>
                                <to variable="sizeOfFlightList"/>
                            </copy>
                            <copy>
                                <from>$AddFlightToItineraryOperationIn.addFlightRequest/flight</from>
                                <to>$flightToBook/ns0:flightInfo</to>
                            </copy>
                            <copy>
                                <from>'unconfirmed'</from>
                                <to>$flightToBook/ns0:bookingStatus</to>
                            </copy>
                        </assign>
                        <assign name="addFlightVariable">
                           
                            <copy>
                                <from>$AddFlightToItineraryOperationIn.addFlightRequest/customerID</from>
                                <to>$AddFlightToItineraryOperationOut.addFlightResult/customerID</to>
                            </copy>
                            <copy>
                                <from>$AddFlightToItineraryOperationIn.addFlightRequest/itineraryNo</from>
                                <to>$AddFlightToItineraryOperationOut.addFlightResult/itineraryNo</to>
                            </copy>
                            <copy>
                                <from>'success'</from>
                                <to>$AddFlightToItineraryOperationOut.addFlightResult/status</to>
                            </copy>
                            <copy>
                                <from variable="flightToBook"/>
                                <to>$BPEL_itinerary/ns0:flightBookingList[$sizeOfFlightList + 1]
                                    <sxed:editor>
                                        <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$sizeOfFlightList + 1]" source="to"/>
                                    </sxed:editor>
                                </to>
                            </copy>
                        </assign>
                        <reply name="ReplyAddFlight" partnerLink="travelGoodLink" operation="addFlightToItineraryOperation" portType="ns2:travelGoodPortType" variable="AddFlightToItineraryOperationOut"/>
                    </sequence>
                </onMessage>
               
                <onMessage partnerLink="travelGoodLink" operation="addHotelToItineraryOperation" portType="ns2:travelGoodPortType" variable="AddHotelToItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence6">
                        <assign name="initialVarHotel">
                            <copy>
                                <from>count($BPEL_itinerary/ns0:hotelBookingList/ns0:hotelInfo)</from>
                                <to variable="sizeOfHotelList"/>
                            </copy>
                            <copy>
                                <from>'unconfirmed'</from>
                                <to>$hotelToBook/ns0:bookingStatus</to>
                            </copy>
                            <copy>
                                <from>$AddHotelToItineraryOperationIn.addHotelRequest/hotel</from>
                                <to>$hotelToBook/ns0:hotelInfo</to>
                            </copy>
                        </assign>
                        <assign name="addHotelVariable">
                            <copy>
                                <from variable="hotelToBook"/>
                                <to>$BPEL_itinerary/ns0:hotelBookingList[$sizeOfHotelList + 1]
                                    <sxed:editor>
                                        <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$sizeOfHotelList + 1]" source="to"/>
                                    </sxed:editor>
                                </to>
                            </copy>
                            <copy>
                                <from>'success'</from>
                                <to>$AddHotelToItineraryOperationOut.addHotelResult/status</to>
                            </copy>
                            <copy>
                                <from>$AddHotelToItineraryOperationIn.addHotelRequest/itineraryNo</from>
                                <to>$AddHotelToItineraryOperationOut.addHotelResult/itineraryNo</to>
                            </copy>
                            <copy>
                                <from>$AddHotelToItineraryOperationIn.addHotelRequest/customerID</from>
                                <to>$AddHotelToItineraryOperationOut.addHotelResult/customerID</to>
                            </copy>
                        </assign>
                        <reply name="ReplyAddHotel" partnerLink="travelGoodLink" operation="addHotelToItineraryOperation" portType="ns2:travelGoodPortType" variable="AddHotelToItineraryOperationOut"/>
                    </sequence>
                </onMessage>
                
                 <onMessage partnerLink="travelGoodLink" operation="getItineraryOperation" portType="ns2:travelGoodPortType" variable="GetItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence5">
                        <assign name="findItinerary">
                            <copy>
                                <from variable="BPEL_itinerary"/>
                                <to variable="GetItineraryOperationOut" part="itineraryResult"/>
                            </copy>
                        </assign>
                        <reply name="ReplyGetIT" partnerLink="travelGoodLink" operation="getItineraryOperation" portType="ns2:travelGoodPortType" variable="GetItineraryOperationOut"/>
                    </sequence>
                </onMessage>
                         <onMessage partnerLink="travelGoodLink" operation="cancelItineraryOperation" portType="ns2:travelGoodPortType" variable="CancelItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence3">
                        <assign name="AssignValue">
                            <copy>
                                    <from>false()</from>
                                        <to variable="planning"/>
                                </copy>
                            <copy>
                                <from>$CancelItineraryOperationIn.cancelItineraryQuery/itineraryNo</from>
                                <to>$CancelItineraryOperationOut.cancelItineraryResult/itineraryNo</to>
                            </copy>
                            <copy>
                                <from>$CancelItineraryOperationIn.cancelItineraryQuery/customerID</from>
                                <to>$CancelItineraryOperationOut.cancelItineraryResult/customerID</to>
                            </copy>
                            <copy>
                                <from>'success'</from>
                                <to>$CancelItineraryOperationOut.cancelItineraryResult/status</to>
                            </copy>
                        </assign>
                        <reply name="ReplyCancelIT" partnerLink="travelGoodLink" operation="cancelItineraryOperation" portType="ns2:travelGoodPortType" variable="CancelItineraryOperationOut"/>
                        <exit name="Exit1"/>
                    </sequence>
                </onMessage>
                <onMessage partnerLink="travelGoodLink" operation="bookItineraryOperation" portType="ns2:travelGoodPortType" variable="BookItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence9">
                        <scope name="ScopeBooking">
                            <faultHandlers>
                                <catch faultName="tns:fault1">
                                    <sequence name="Sequence11">
                                        <forEach name="ForEachFlight" parallel="no" counterName="ForEachFlight2Counter">
                                                <startCounterValue>1</startCounterValue>
                                                    <finalCounterValue>$sizeOfFlightList + 1</finalCounterValue>
                                                    <scope name="Scope3">
                                                        <variables>
                                                                <variable name="CancelFlightOut" messageType="tns:cancelFlightResponse"/>
                                                                    <variable name="CancelFlightIn" messageType="tns:cancelFlightRequest"/>
                                                            </variables>
                                                        <faultHandlers>
                                                            <catch faultName="tns:fault1">
                                                                <empty name="DoNothing"/>
                                                            </catch>
                                                        </faultHandlers>
                                                        <if name="IfStatusConfirmed">
                                                                <condition>'confirmed' = $BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]/ns0:bookingStatus
                                                                            <sxed:editor>
                                                                                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="from"/>
                                                                            </sxed:editor>
                                                                    </condition>
                                                                    <sequence name="Sequence12">
                                                                        <assign name="AssignInput">
                                                                                <copy>
                                                                                        <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]/ns0:flightInfo/ns1:bookingNumber
                                                                                                    <sxed:editor>
                                                                                                        <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="from"/>
                                                                                                    </sxed:editor>
                                                                                            </from>
                                                                                            <to>$CancelFlightIn.cancelFlightQuery/ns1:bookingNumber</to>
                                                                                    </copy>
                                                                                    <copy>
                                                                                        <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]/ns0:flightInfo/ns1:flightPrice
                                                                                                    <sxed:editor>
                                                                                                        <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="from"/>
                                                                                                    </sxed:editor>
                                                                                            </from>
                                                                                            <to>$CancelFlightIn.cancelFlightQuery/ns1:flightPrice</to>
                                                                                    </copy>
                                                                                    <copy>
                                                                                        <from>$BookItineraryOperationIn.bookItineraryQuery/creditCardInfo</from>
                                                                                            <to>$CancelFlightIn.cancelFlightQuery/ns1:creditcardInfo</to>
                                                                                    </copy>
                                                                            </assign>
                                                                            <invoke name="InvokeCancelFlight" partnerLink="flightLink" operation="cancelFlight" portType="tns:lameDuckPortType" inputVariable="CancelFlightIn" outputVariable="CancelFlightOut"/>
                                                                            <if name="IfSuccessCancelled">
                                                                                <condition>$CancelFlightOut.cancelResult</condition>
                                                                                    <assign name="changeStatus">
                                                                                        <copy>
                                                                                                <from>'canceled'</from>
                                                                                                    <to>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]/ns0:bookingStatus
                                                                                                            <sxed:editor>
                                                                                                                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight2Counter]" source="to"/>
                                                                                                            </sxed:editor>
                                                                                                    </to>
                                                                                            </copy>
                                                                                    </assign>
                                                                            </if>
                                                                    </sequence>
                                                            </if>
                                                    </scope>
                                            </forEach>
                                            <assign name="AssignReply">
                                                <copy>
                                                        <from>$BookItineraryOperationIn.bookItineraryQuery/customerID</from>
                                                            <to>$BookItineraryOperationOut.bookItineraryResult/customerID</to>
                                                    </copy>
                                                    <copy>
                                                        <from>$BookItineraryOperationIn.bookItineraryQuery/itineraryNo</from>
                                                            <to>$BookItineraryOperationOut.bookItineraryResult/itineraryNo</to>
                                                    </copy>
                                                    <copy>
                                                        <from>'failed'</from>
                                                            <to>$BookItineraryOperationOut.bookItineraryResult/status</to>
                                                    </copy>
                                            </assign>
                                            <reply name="ReplyBookItinerary" partnerLink="travelGoodLink" operation="bookItineraryOperation" portType="ns2:travelGoodPortType" variable="BookItineraryOperationOut"/>
                                    </sequence>
                                </catch>
                                <catch faultName="ns4:bookHotelOperationFault">
                                    <sequence name="Sequence15">
                                        <if name="IfFNotEmpty">
                                            <condition>count($BPEL_itinerary/ns0:flightBookingList/ns0:flightInfo) &gt; 0</condition>
                                                <forEach name="ForEachF" parallel="no" counterName="ForEachFlight3Counter">
                                                    <startCounterValue>1</startCounterValue>
                                                        <finalCounterValue>$sizeOfFlightList + 1</finalCounterValue>
                                                        <scope name="Scope8">
                                                            <variables>
                                                                    <variable name="CancelFlightOut" messageType="tns:cancelFlightResponse"/>
                                                                        <variable name="CancelFlightIn" messageType="tns:cancelFlightRequest"/>
                                                                </variables>
                                                            <faultHandlers>
                                                                <catch faultName="tns:fault1">
                                                                    <empty name="DoNothing"/>
                                                                </catch>
                                                            </faultHandlers>
                                                            <if name="IfStatusConfirmed">
                                                                    <condition>'confirmed' = $BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]/ns0:bookingStatus
                                                        <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </condition>
                                                                        <sequence name="Sequence22">
                                                                            <assign name="AssignInput">
                                                                                    <copy>
                                                                                            <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]/ns0:flightInfo/ns1:bookingNumber
                                                                    <sxed:editor>
                                                                                                            <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="from"/>
                                                                                                        </sxed:editor>
                                                                                                </from>
                                                                                                <to>$CancelFlightIn.cancelFlightQuery/ns1:bookingNumber</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]/ns0:flightInfo/ns1:flightPrice
                                                                    <sxed:editor>
                                                                                                            <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="from"/>
                                                                                                        </sxed:editor>
                                                                                                </from>
                                                                                                <to>$CancelFlightIn.cancelFlightQuery/ns1:flightPrice</to>
                                                                                        </copy>
                                                                                        <copy>
                                                                                            <from>$BookItineraryOperationIn.bookItineraryQuery/creditCardInfo</from>
                                                                                                <to>$CancelFlightIn.cancelFlightQuery/ns1:creditcardInfo</to>
                                                                                        </copy>
                                                                                </assign>
                                                                                <invoke name="InvokeCancelF" partnerLink="flightLink" operation="cancelFlight" portType="tns:lameDuckPortType" inputVariable="CancelFlightIn" outputVariable="CancelFlightOut"/>
                                                                                <if name="IfSuccess">
                                                                                    <condition>$CancelFlightOut.cancelResult</condition>
                                                                                        <assign name="changeStatusF">
                                                                                            <copy>
                                                                                                    <from>'canceled'</from>
                                                                                                        <to>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]/ns0:bookingStatus
                                                                        <sxed:editor>
                                                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlight3Counter]" source="to"/>
                                                                                                                </sxed:editor>
                                                                                                        </to>
                                                                                                </copy>
                                                                                        </assign>
                                                                                </if>
                                                                        </sequence>
                                                                </if>
                                                        </scope>
                                                </forEach>
                                        </if>
                                        <if name="IfHotNotEmpty">
                                            <condition>count($BPEL_itinerary/ns0:hotelBookingList/ns0:hotelInfo) &gt; 0</condition>
                                                <forEach name="ForEachH" parallel="no" counterName="ForEachHotel2Counter">
                                                    <startCounterValue>1</startCounterValue>
                                                        <finalCounterValue>$sizeOfHotelList + 1</finalCounterValue>
                                                        <scope name="Scope5">
                                                            <variables>
                                                                    <variable name="CancelHotelOperationOut" messageType="ns4:cancelHotelOperationResponse"/>
                                                                        <variable name="CancelHotelOperationIn" messageType="ns4:cancelHotelOperationRequest"/>
                                                                </variables>
                                                            <faultHandlers>
                                                                <catch faultName="ns4:cancelHotelOperationFault">
                                                                    <empty name="DoNothing"/>
                                                                </catch>
                                                            </faultHandlers>
                                                            <if name="IfStatusConfirmed">
                                                                    <condition>'confirmed' = $BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]/ns0:bookingStatus
                                                                        <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </condition>
                                                                        <sequence name="Sequence14">
                                                                            <assign name="AssignInput">
                                                                                    <copy>
                                                                                            <from>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]/ns0:hotelInfo/ns3:bookingNo
                                                                                                <sxed:editor>
                                                                                                            <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]" source="from"/>
                                                                                                        </sxed:editor>
                                                                                                </from>
                                                                                                <to variable="CancelHotelOperationIn" part="bookingCancellation"/>
                                                                                        </copy>
                                                                                </assign>
                                                                                <invoke name="InvokeCancelHotel" partnerLink="HotelLink" operation="cancelHotelOperation" portType="ns4:hotelServicePortType" inputVariable="CancelHotelOperationIn" outputVariable="CancelHotelOperationOut"/>
                                                                                <if name="IfSuccess">
                                                                                    <condition>$CancelHotelOperationOut.cancellationResult</condition>
                                                                                        <assign name="changeStatusHotel">
                                                                                            <copy>
                                                                                                    <from>'canceled'</from>
                                                                                                        <to>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]/ns0:bookingStatus
                                                                                                        <sxed:editor>
                                                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotel2Counter]" source="to"/>
                                                                                                                </sxed:editor>
                                                                                                        </to>
                                                                                                </copy>
                                                                                        </assign>
                                                                                </if>
                                                                        </sequence>
                                                                </if>
                                                        </scope>
                                                </forEach>
                                        </if>
                                        <assign name="Assign22">
                                            <copy>
                                                <from>$BPEL_itinerary/ns0:itineraryNo</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/itineraryNo</to>
                                            </copy>
                                            <copy>
                                                <from>$BookItineraryOperationIn.bookItineraryQuery/customerID</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/customerID</to>
                                            </copy>
                                            <copy>
                                                <from>'failed'</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/status</to>
                                            </copy>
                                        </assign>
                                        <reply name="Reply9" partnerLink="travelGoodLink" operation="bookItineraryOperation" portType="ns2:travelGoodPortType" variable="BookItineraryOperationOut"/>
                                    </sequence>
                                </catch>
                            </faultHandlers>
                            <sequence name="Sequence13">
                                <if name="IfFlightNotEmpty">
                                    <condition>count($BPEL_itinerary/ns0:flightBookingList/ns0:flightInfo) &gt; 0</condition>
                                    <forEach name="ForEachFlightToBook" parallel="no" counterName="ForEachFlightCounter">
                                        <startCounterValue>1</startCounterValue>
                                            <finalCounterValue>$sizeOfFlightList + 1</finalCounterValue>
                                            <scope name="Scope1">
                                            <variables>
                                                    <variable name="BookFlightOut" messageType="tns:bookFlightResponse"/>
                                                        <variable name="BookFlightIn" messageType="tns:bookFlightRequest"/>
                                                </variables>
                                                <sequence name="Sequence8">
                                                    <assign name="AssignInput">
                                                            <copy>
                                                                    <from>$BookItineraryOperationIn.bookItineraryQuery/creditCardInfo</from>
                                                                        <to>$BookFlightIn.bookFlightQuery/ns1:creditcardInfo</to>
                                                                </copy>
                                                                <copy>
                                                                    <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]/ns0:flightInfo/ns1:bookingNumber
                                                                <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </from>
                                                                        <to>$BookFlightIn.bookFlightQuery/ns1:bookingNumber</to>
                                                                </copy>
                                                        </assign>
                                                        <invoke name="InvokeBookFlight" partnerLink="flightLink" operation="bookFlight" portType="tns:lameDuckPortType" inputVariable="BookFlightIn" outputVariable="BookFlightOut"/>
                                                        <if name="IfBookSuccess">
                                                            <condition>$BookFlightOut.bookingResult</condition>
                                                                <assign name="changeBookStatus">
                                                                    <copy>
                                                                            <from>'confirmed'</from>
                                                                                <to>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]/ns0:bookingStatus
                                                                    <sxed:editor>
                                                                                            <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCounter]" source="to"/>
                                                                                        </sxed:editor>
                                                                                </to>
                                                                        </copy>
                                                                </assign>
                                                        </if>
                                                </sequence>
                                        </scope>
                                    </forEach>
                                </if>
                                <if name="IfHotelNotEmpty">
                                    <condition>count($BPEL_itinerary/ns0:hotelBookingList/ns0:hotelInfo) &gt; 0</condition>
                                    <forEach name="ForEachHotelToBook" parallel="no" counterName="ForEachHotelBCounter">
                                        <startCounterValue>1</startCounterValue>
                                        <finalCounterValue>$sizeOfHotelList + 1</finalCounterValue>
                                        <scope name="Scope9">
                                            <variables>
                                                <variable name="BookHotelOperationOut" messageType="ns4:bookHotelOperationResponse"/>
                                                <variable name="BookHotelOperationIn" messageType="ns4:bookHotelOperationRequest"/>
                                            </variables>
                                            <sequence name="Sequence23">
                                                <assign name="AssignInput">
                                                    <copy>
                                                        <from>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]/ns0:hotelInfo/ns3:bookingNo
                                                            <sxed:editor>
                                                                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]" source="from"/>
                                                            </sxed:editor>
                                                        </from>
                                                        <to>$BookHotelOperationIn.bookingWithCreditCard/ns3:bookingNumber</to>
                                                    </copy>
                                                    <copy>
                                                        <from>$BookItineraryOperationIn.bookItineraryQuery/creditCardInfo</from>
                                                        <to>$BookHotelOperationIn.bookingWithCreditCard/ns3:creditCardInfo</to>
                                                    </copy>
                                                </assign>
                                                <invoke name="InvokeBookHotel" partnerLink="HotelLink" operation="bookHotelOperation" portType="ns4:hotelServicePortType" inputVariable="BookHotelOperationIn" outputVariable="BookHotelOperationOut"/>
                                                <if name="IfBookSuccess">
                                                    <condition>$BookHotelOperationOut.bookingResult</condition>
                                                    <assign name="changeStatus">
                                                        <copy>
                                                            <from>'confirmed'</from>
                                                            <to>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]/ns0:bookingStatus
                                                                <sxed:editor>
                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelBCounter]" source="to"/>
                                                                </sxed:editor>
                                                            </to>
                                                        </copy>
                                                    </assign>
                                                </if>
                                            </sequence>
                                        </scope>
                                    </forEach>
                                </if>
                                <assign name="setVar">
                                    <copy>
                                            <from>'success'</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/status</to>
                                        </copy>
                                        <copy>
                                            <from>$BPEL_itinerary/ns0:itineraryNo</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/itineraryNo</to>
                                        </copy>
                                        <copy>
                                            <from>$BookItineraryOperationIn.bookItineraryQuery/customerID</from>
                                                <to>$BookItineraryOperationOut.bookItineraryResult/customerID</to>
                                        </copy>
                                </assign>
                                <reply name="ResponseBooking" partnerLink="travelGoodLink" operation="bookItineraryOperation" portType="ns2:travelGoodPortType" variable="BookItineraryOperationOut"/>
                                <assign name="EndPlanning">
                                    <copy>
                                            <from>false()</from>
                                                <to variable="planning"/>
                                        </copy>
                                    <copy>
                                        <from>true()</from>
                                        <to variable="cancellingPhase"/>
                                    </copy>
                                </assign>
                            </sequence>
                        </scope>
                    </sequence>
                </onMessage>
            </pick>
        </while>
        <while name="cancelling">
            <condition>$cancellingPhase</condition>
            <pick name="Pick2">
                <onMessage partnerLink="travelGoodLink" operation="readItineraryOperation" portType="ns2:travelGoodPortType" variable="ReadItineraryOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence16">
                        <assign name="AssignItinerary">
                            <copy>
                                <from variable="BPEL_itinerary"/>
                                <to variable="ReadItineraryOperationOut" part="readItineraryResult"/>
                            </copy>
                        </assign>
                        <reply name="ReplyItinerary" partnerLink="travelGoodLink" operation="readItineraryOperation" portType="ns2:travelGoodPortType" variable="ReadItineraryOperationOut"/>
                    </sequence>
                </onMessage>
                <onMessage partnerLink="travelGoodLink" operation="cancelBookingOperation" portType="ns2:travelGoodPortType" variable="CancelBookingOperationIn">
                    <correlations>
                        <correlation set="CorrelationSet1" initiate="no"/>
                    </correlations>
                    <sequence name="Sequence17">
                        <flow name="Flow1">
                            <sequence name="FlowSequence">
                                <if name="IfHotelNotEmpty">
                                    <condition>count($BPEL_itinerary/ns0:hotelBookingList/ns0:hotelInfo) &gt; 0</condition>
                                    <forEach name="ForEachHotelCancel" parallel="no" counterName="ForEachHotelCancelCounter">
                                        <startCounterValue>1</startCounterValue>
                                        <finalCounterValue>count($BPEL_itinerary/ns0:hotelBookingList/ns0:hotelInfo)</finalCounterValue>
                                        <scope name="Scope7">
                                                <variables>
                                                        <variable name="CancelHotelOperationOut" messageType="ns4:cancelHotelOperationResponse"/>
                                                            <variable name="CancelHotelOperationIn" messageType="ns4:cancelHotelOperationRequest"/>
                                                    </variables>
                                                <faultHandlers>
                                                    <catch faultName="ns4:cancelHotelOperationFault">
                                                        <sequence name="Sequence26">
                                                            <empty name="DoNothing"/>
                                                        </sequence>
                                                    </catch>
                                                </faultHandlers>
                                                <sequence name="Sequence19">
                                                    <if name="IfConfirmed">
                                                        <condition>'confirmed' = $BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]/ns0:bookingStatus
                                                            <sxed:editor>
                                                                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]" source="from"/>
                                                            </sxed:editor>
                                                        </condition>
                                                        <sequence name="Sequence27">
                                                            <assign name="AssignInput">
                                                                <copy>
                                                                    <from>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]/ns0:hotelInfo/ns3:bookingNo
                                                <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </from>
                                                                        <to variable="CancelHotelOperationIn" part="bookingCancellation"/>
                                                                </copy>
                                                            </assign>
                                                            <invoke name="InvokeCancelHotel" partnerLink="HotelLink" operation="cancelHotelOperation" portType="ns4:hotelServicePortType" inputVariable="CancelHotelOperationIn" outputVariable="CancelHotelOperationOut"></invoke>
                                                            <if name="IfCancelSuccess">
                                                                <condition>$CancelHotelOperationOut.cancellationResult</condition>
                                                                    <assign name="changeStatus">
                                                                        <copy>
                                                                                <from>'canceled'</from>
                                                                                    <to>$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]/ns0:bookingStatus
                                                                        <sxed:editor>
                                                                                                <sxed:predicate path="$BPEL_itinerary/ns0:hotelBookingList[$ForEachHotelCancelCounter]" source="to"/>
                                                                                            </sxed:editor>
                                                                                    </to>
                                                                            </copy>
                                                                    </assign>
                                                            </if>
                                                        </sequence>
                                                    </if>
                                                    </sequence>
                                            </scope>
                                    </forEach>
                                </if>
                            </sequence>
                            <sequence name="FlowSequence1">
                                <if name="IfFlightNotEmpty">
                                    <condition>count($BPEL_itinerary/ns0:flightBookingList/ns0:flightInfo) &gt; 0</condition>
                                    <forEach name="ForEachFlightCancel" parallel="no" counterName="ForEachFlightCancelCounter">
                                        <startCounterValue>1</startCounterValue>
                                        <finalCounterValue>count($BPEL_itinerary/ns0:flightBookingList/ns0:flightInfo)</finalCounterValue>
                                        <scope name="Scope6">
                                            <variables>
                                                <variable name="CancelFlightOut" messageType="ns5:cancelFlightResponse"/>
                                                        <variable name="CancelFlightIn" messageType="ns5:cancelFlightRequest"/>
                                                </variables>
                                                <faultHandlers>
                                                    <catch faultName="ns5:fault1">
                                                        <sequence name="Sequence25">
                                                            <empty name="DoNothing"/>
                                                        </sequence>
                                                    </catch>
                                                </faultHandlers>
                                                <sequence name="Sequence18">
                                                    <if name="IfConfirmed">
                                                        <condition>'confirmed' = $BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]/ns0:bookingStatus
                                                            <sxed:editor>
                                                                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="from"/>
                                                            </sxed:editor>
                                                        </condition>
                                                        <sequence name="Sequence28">
                                                            <assign name="AssignInput">
                                                                <copy>
                                                                    <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]/ns0:flightInfo/ns1:bookingNumber
                                                    <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </from>
                                                                        <to>$CancelFlightIn.cancelFlightQuery/ns1:bookingNumber</to>
                                                                </copy>
                                                                    <copy>
                                                                    <from>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]/ns0:flightInfo/ns1:flightPrice
                                                    <sxed:editor>
                                                                                    <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="from"/>
                                                                                </sxed:editor>
                                                                        </from>
                                                                        <to>$CancelFlightIn.cancelFlightQuery/ns1:flightPrice</to>
                                                                </copy>
                                                                    <copy>
                                                                    <from>$BookItineraryOperationIn.bookItineraryQuery/creditCardInfo</from>
                                                                        <to>$CancelFlightIn.cancelFlightQuery/ns1:creditcardInfo</to>
                                                                </copy>
                                                                    <copy>
                                                                    <from>false()</from>
                                                                        <to variable="CancelFlightOut" part="cancelResult"/>
                                                                </copy>
                                                            </assign>
                                                            <invoke name="InvokeCancelFlight" partnerLink="flightLink" operation="cancelFlight" portType="ns5:lameDuckPortType" inputVariable="CancelFlightIn" outputVariable="CancelFlightOut"/>
                                                            <if name="IfCancelSuccess">
                                                                <condition>$CancelFlightOut.cancelResult</condition>
                                                                    <assign name="changeStatus">
                                                                        <copy>
                                                                                <from>'canceled'</from>
                                                                                    <to>$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]/ns0:bookingStatus
                                                                    <sxed:editor>
                                                                                                <sxed:predicate path="$BPEL_itinerary/ns0:flightBookingList[$ForEachFlightCancelCounter]" source="to"/>
                                                                                            </sxed:editor>
                                                                                    </to>
                                                                            </copy>
                                                                    </assign>
                                                            </if>
                                                        </sequence>
                                                    </if>
                                                </sequence>
                                        </scope>
                                    </forEach>
                                </if>
                            </sequence>
                        </flow>
                        <assign name="setReaply">
                            <copy>
                                <from>'success'</from>
                                <to>$CancelBookingOperationOut.cancelBookingResult/status</to>
                            </copy>
                            <copy>
                                <from>$BPEL_itinerary/ns0:itineraryNo</from>
                                <to>$CancelBookingOperationOut.cancelBookingResult/itineraryNo</to>
                            </copy>
                            <copy>
                                <from>$CancelBookingOperationIn.cancelBookingQuery/customerID</from>
                                <to>$CancelBookingOperationOut.cancelBookingResult/customerID</to>
                            </copy>
                        </assign>
                        <reply name="ReplyCancelBooking" partnerLink="travelGoodLink" operation="cancelBookingOperation" portType="ns2:travelGoodPortType" variable="CancelBookingOperationOut"/>
                    </sequence>
                </onMessage>
            </pick>
        </while>
    </sequence>
</process>
